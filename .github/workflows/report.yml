name: Generate MeanReversionMomentum Report

on:
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run backtest + forward test (KuCoin, 5m)
        run: |
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/freqtrade" \
            -w /freqtrade \
            freqtradeorg/freqtrade:stable \
            bash -lc '
              # 1) Download data (60 days, KuCoin, 5m)
              freqtrade download-data \
                --config user_data/config.json \
                --exchange kucoin \
                --timeframe 5m \
                --days 60

              # 2) Backtest 60 days – write to fixed meta file
              freqtrade backtesting \
                --config user_data/config.json \
                --strategy MeanReversionMomentum \
                --timeframe 5m \
                --timerange 20251001-20251130 \
                --export trades \
                --backtest-filename user_data/backtest_results/MeanRev_Backtest

              # 3) Forward test last 2 days – fixed meta file
              freqtrade backtesting \
                --config user_data/config.json \
                --strategy MeanReversionMomentum \
                --timeframe 5m \
                --timerange -2d \
                --export trades \
                --backtest-filename user_data/backtest_results/MeanRev_Forward
            '

      - name: Generate HTML report
        run: |
          python - << 'PY'
          import json, pathlib, html

          base = pathlib.Path("user_data/backtest_results")

          backtest_meta = json.loads((base / "MeanRev_Backtest.meta.json").read_text())
          fwd_meta      = json.loads((base / "MeanRev_Forward.meta.json").read_text())

          def find_key(obj, key):
              if isinstance(obj, dict):
                  if key in obj:
                      return obj[key]
                  for v in obj.values():
                      r = find_key(v, key)
                      if r is not None:
                          return r
              elif isinstance(obj, list):
                  for v in obj:
                      r = find_key(v, key)
                      if r is not None:
                          return r
              return None

          def extract(meta):
              trades = find_key(meta, "total_trades") or 0
              avg_profit = find_key(meta, "avg_profit") or 0.0
              tot_profit_abs = find_key(meta, "total_profit_abs") or 0.0
              return int(trades), float(avg_profit), float(tot_profit_abs)

          bt_trades, bt_avg, bt_tot = extract(backtest_meta)
          fw_trades, fw_avg, fw_tot = extract(fwd_meta)

          docs = pathlib.Path("docs")
          docs.mkdir(exist_ok=True)
          out = docs / "index.html"

          out.write_text(f"""<!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>MeanReversionMomentum Strategy Report</title>
          </head>
          <body>
            <h1>MeanReversionMomentum Strategy Report</h1>

            <h2>Backtest (60 days, KuCoin, 5m)</h2>
            <table border="1" cellpadding="4" cellspacing="0">
              <tr><th>Metric</th><th>Value</th></tr>
              <tr><td>Trades</td><td>{bt_trades}</td></tr>
              <tr><td>Avg Profit %</td><td>{bt_avg:.4f}</td></tr>
              <tr><td>Total Profit (USDT)</td><td>{bt_tot:.4f}</td></tr>
            </table>

            <h2>Forward Test (~2 days, KuCoin, 5m)</h2>
            <table border="1" cellpadding="4" cellspacing="0">
              <tr><th>Metric</th><th>Value</th></tr>
              <tr><td>Trades</td><td>{fw_trades}</td></tr>
              <tr><td>Avg Profit %</td><td>{fw_avg:.4f}</td></tr>
              <tr><td>Total Profit (USDT)</td><td>{fw_tot:.4f}</td></tr>
            </table>
          </body>
          </html>
          """)
          PY

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: strategy-report-meanreversion
          path: docs/index.html
