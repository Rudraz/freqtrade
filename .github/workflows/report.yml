name: Generate Strategy Report

on:
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Pull Freqtrade Docker Image
        run: docker pull freqtradeorg/freqtrade:stable

      - name: Run backtest and forward test (KuCoin, 5m)
        run: |
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/freqtrade" \
            -w /freqtrade \
            freqtradeorg/freqtrade:stable \
            bash -lc '
              mkdir -p user_data/backtest_results

              # 60-day backtest
              freqtrade download-data \
                --config user_data/config.json \
                --exchange kucoin \
                --timeframe 5m \
                --days 60

              freqtrade backtesting \
                --config user_data/config.json \
                --strategy MeanReversionMomentum \
                --timeframe 5m \
                --backtest-filename user_data/backtest_results/MeanRev_Backtest

              # ~2-day forward slice
              freqtrade backtesting \
                --config user_data/config.json \
                --strategy MeanReversionMomentum \
                --timeframe 5m \
                --timerange -2d \
                --backtest-filename user_data/backtest_results/MeanRev_Forward
            '

      - name: Generate HTML report from meta files
        run: |
          python -m pip install --upgrade pip

          python << 'EOF'
          import json
          import pathlib

          base = pathlib.Path("user_data/backtest_results")

          # These are created by --backtest-filename above:
          bt_meta_path = base / "MeanRev_Backtest.meta.json"
          fw_meta_path = base / "MeanRev_Forward.meta.json"

          bt_meta = json.loads(bt_meta_path.read_text())
          fw_meta = json.loads(fw_meta_path.read_text())

          def get(d, *keys, default=0.0):
              for k in keys:
                  if isinstance(d, dict) and k in d:
                      return d[k]
              return default

          def extract(meta):
              trades = int(get(meta, "total_trades", default=0))
              avg_profit = float(get(meta, "avg_profit", "avg_profit_pct", default=0.0))
              tot_profit = float(get(meta, "total_profit", "total_profit_abs", default=0.0))
              return trades, avg_profit, tot_profit

          bt_trades, bt_avg, bt_tot = extract(bt_meta)
          fw_trades, fw_avg, fw_tot = extract(fw_meta)

          html = f"""<!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>MeanReversionMomentum Strategy Report</title>
          </head>
          <body>
            <h1>MeanReversionMomentum Strategy Report</h1>

            <h2>Backtest (60 days, KuCoin, 5m)</h2>
            <table border="1" cellpadding="4" cellspacing="0">
              <tr><th>Metric</th><th>Value</th></tr>
              <tr><td>Trades</td><td>{bt_trades}</td></tr>
              <tr><td>Avg Profit %</td><td>{bt_avg:.4f}</td></tr>
              <tr><td>Total Profit (USDT)</td><td>{bt_tot:.4f}</td></tr>
            </table>

            <h2>Forward Test (~2 days, KuCoin, 5m)</h2>
            <table border="1" cellpadding="4" cellspacing="0">
              <tr><th>Metric</th><th>Value</th></tr>
              <tr><td>Trades</td><td>{fw_trades}</td></tr>
              <tr><td>Avg Profit %</td><td>{fw_avg:.4f}</td></tr>
              <tr><td>Total Profit (USDT)</td><td>{fw_tot:.4f}</td></tr>
            </table>
          </body>
          </html>
          """

          pathlib.Path("report_meanreversion.html").write_text(html, encoding="utf-8")
          EOF

      - name: Upload HTML and meta
        uses: actions/upload-artifact@v4
        with:
          name: strategy-report-meanreversion
          path: |
            report_meanreversion.html
            user_data/backtest_results/MeanRev_Backtest.meta.json
            user_data/backtest_results/MeanRev_Forward.meta.json
